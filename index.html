<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歐大選擇權教室隨堂測驗</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&display=swap');
        body { background-color: #fdf8f1; font-family: sans-serif; margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .certificate-container {
            background-image: radial-gradient(circle at 50% 50%, transparent 80%, rgba(217, 119, 6, 0.05) 100%);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        @media print {
            body * { visibility: hidden; }
            .certificate-container, .certificate-container * { visibility: visible; }
            .certificate-container { position: absolute; left: 0; top: 0; width: 100%; border: none; }
        }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        /**
         * ==========================================
         * 1. Google 表單與資料來源設定
         * ==========================================
         */
        const CONFIG = {
            // 提交表單的網址
            formActionUrl: "https://docs.google.com/forms/d/e/1FAIpQLSeoBO2Dumc6wTJ32dvoMhe-cfcaBh46DOWCb4EUl9XDPMvLmw/formResponse",
            // 欄位 ID
            nameEntryId: "entry.763113619",
            scoreEntryId: "entry.236333802",
            emailEntryId: "emailAddress", 
            // 您提供的公開 CSV 連結
            SHEET_CSV_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVeIf30C4q_dI4RAoaNHjItk0F35QdtIvizSyJWbbNfnVxhYj-NyWocq67QknUEFr1_0oBvgJntMbi/pub?output=csv" 
        };

        // --- 內嵌圖標 ---
        const BookOpen = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>);
        const GraduationCap = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>);
        const ChevronRight = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>);
        const Home = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const Download = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>);
        const Trophy = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>);
        const Check = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>);
        const Loader = ({ className }) => (<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>);

        const defaultQuestions = [
            { q: "關於選擇權，買方（Buy）與賣方（Sell）的風險敘述何者正確？", a: ["買方風險有限，賣方風險無限", "賣方風險有限，買方風險無限", "兩者風險皆為無限", "兩者風險皆為有限"], correct: 0 },
            { q: "當你預期未來行情會「大漲」，最適合的簡單策略是？", a: ["Buy Put", "Sell Call", "Buy Call", "Sell Put"], correct: 2 },
            { q: "台指選擇權中，所謂的「週選擇權」通常在每週幾進行結算？", a: ["週一", "週二", "週三", "週五"], correct: 2 },
            { q: "歐大常提到的「賣出勒式策略」是指同時做什麼動作？", a: ["買進 Call，買進 Put", "賣出不同履約價的 Call 與 Put", "賣出 Call，買進 Put", "買進 Call，賣出 Put"], correct: 1 },
            { q: "在期權交易中，「時間價值」的流逝（Theta）對哪一方最有利？", a: ["買方", "賣方", "證券商", "期交所"], correct: 1 }
        ];

        function App() {
            const [view, setView] = useState('home');
            const [playerName, setPlayerName] = useState('');
            const [playerEmail, setPlayerEmail] = useState('');
            const [currentQuestions, setCurrentQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [answers, setAnswers] = useState([]);
            const [score, setScore] = useState(0);
            const [submitStatus, setSubmitStatus] = useState('idle');
            const [leaderboard, setLeaderboard] = useState([]);
            const [isLoadingLeaderboard, setIsLoadingLeaderboard] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');

            const formRef = useRef(null);

            // 強化版解析器：專門處理 Google 試算表複雜格式
            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
                if (lines.length < 2) return [];
                
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                
                // 動態匹配索引：根據截圖 A:時間(0), B:郵箱(1), C:姓名(2), D:分數(3)
                let nameIdx = headers.findIndex(h => h.includes("姓名") || h.includes("名稱") || h.includes("Name"));
                let scoreIdx = headers.findIndex(h => h.includes("分數") || h.includes("成績") || h.includes("Score"));

                // 強制備用索引（如果自動匹配失敗）
                if (nameIdx === -1) nameIdx = 2; 
                if (scoreIdx === -1) scoreIdx = 3;

                return lines.slice(1).map(line => {
                    // 使用逗號分割，但排除括號內的內容
                    const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());
                    
                    const name = cleanCols[nameIdx];
                    const rawScore = cleanCols[scoreIdx];
                    const timestamp = cleanCols[0];

                    return {
                        name: name || "冒險者",
                        score: parseInt(rawScore) || 0,
                        date: timestamp?.split(' ')[0] || ''
                    };
                }).filter(item => item.name && item.name !== "姓名" && item.name !== "未命名的問題");
            };

            const fetchLeaderboard = async () => {
                setIsLoadingLeaderboard(true);
                setErrorMessage('');
                try {
                    // 加入 t 參數強制繞過瀏覽器快取
                    const sep = CONFIG.SHEET_CSV_URL.includes('?') ? '&' : '?';
                    const url = `${CONFIG.SHEET_CSV_URL}${sep}t=${Date.now()}`;
                    
                    const response = await fetch(url, { cache: 'no-store' });
                    if (!response.ok) throw new Error("Fetch failed");
                    
                    const text = await response.text();
                    const data = parseCSV(text);
                    
                    // 依分數高低排序
                    setLeaderboard(data.sort((a, b) => b.score - a.score));
                } catch (e) {
                    console.error("Fetch Error:", e);
                    setErrorMessage("資料同步中，請點擊重試或檢查網路。");
                } finally {
                    setIsLoadingLeaderboard(false);
                }
            };

            const startQuiz = () => {
                if (!playerName.trim()) return setErrorMessage("請輸入您的名稱");
                if (!playerEmail.trim() || !playerEmail.includes('@')) return setErrorMessage("請輸入有效的電子信箱");
                
                setErrorMessage('');
                setCurrentQuestions([...defaultQuestions].sort(() => 0.5 - Math.random()));
                setCurrentIndex(0); setAnswers([]); setScore(0); setSubmitStatus('idle'); setView('quiz');
            };

            const autoSubmitData = () => {
                setSubmitStatus('submitting');
                if (formRef.current) {
                    formRef.current.submit();
                    setSubmitStatus('success');
                    // 延遲更新，確保資料已入庫
                    setTimeout(fetchLeaderboard, 4000);
                }
            };

            const handleAnswer = (idx) => {
                const newAnswers = [...answers, idx]; 
                setAnswers(newAnswers);
                if (currentIndex < 4) {
                    setCurrentIndex(currentIndex + 1);
                } else {
                    let s = 0;
                    currentQuestions.forEach((q, i) => { if (q.correct === newAnswers[i]) s += 20; });
                    setScore(s);
                    setView('result');
                    setTimeout(autoSubmitData, 800);
                }
            };

            return (
                <div className="min-h-screen text-stone-800 p-4 flex flex-col items-center justify-center relative bg-[#fdf8f1]">
                    {/* 隱藏提交區域 */}
                    <div style={{ display: 'none' }}>
                        <iframe name="hidden_iframe" id="hidden_iframe"></iframe>
                        <form 
                            ref={formRef}
                            action={CONFIG.formActionUrl} 
                            method="POST" 
                            target="hidden_iframe"
                        >
                            <input type="hidden" name={CONFIG.nameEntryId} value={playerName} />
                            <input type="hidden" name={CONFIG.scoreEntryId} value={score} />
                            <input type="hidden" name={CONFIG.emailEntryId} value={playerEmail} />
                        </form>
                    </div>

                    <div className="relative w-full max-w-lg z-10 py-6">
                        
                        {/* 首頁 */}
                        {view === 'home' && (
                            <div className="bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-xl border border-amber-100 text-center fade-in">
                                <BookOpen className="w-12 h-12 text-amber-600 mx-auto mb-6" />
                                <h1 className="text-3xl font-bold text-stone-900 mb-2">歐大選擇權教室</h1>
                                <p className="text-stone-500 mb-8 italic">隨堂測驗 — 測驗你的期權實力</p>
                                
                                <div className="space-y-4 mb-6 text-left">
                                    <input type="text" placeholder="您的名稱" className="w-full px-6 py-4 rounded-2xl border-2 border-stone-100 focus:border-amber-400 focus:outline-none text-lg bg-stone-50" value={playerName} onChange={(e) => setPlayerName(e.target.value)} />
                                    <input type="email" placeholder="電子信箱 (系統同步用)" className="w-full px-6 py-4 rounded-2xl border-2 border-stone-100 focus:border-amber-400 focus:outline-none text-lg bg-stone-50" value={playerEmail} onChange={(e) => setPlayerEmail(e.target.value)} />
                                    {errorMessage && <p className="text-red-500 text-sm font-bold text-center">{errorMessage}</p>}
                                </div>

                                <div className="space-y-3">
                                    <button onClick={startQuiz} className="w-full bg-amber-500 text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 text-xl hover:bg-amber-600 active:scale-95 transition-all">開始作答 <ChevronRight className="w-6 h-6" /></button>
                                    <button onClick={() => { setView('leaderboard'); fetchLeaderboard(); }} className="w-full bg-white text-amber-600 border-2 border-amber-100 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 text-lg hover:bg-amber-50 transition-all"><Trophy className="w-5 h-5" /> 觀看排行榜</button>
                                </div>
                            </div>
                        )}

                        {/* 測驗中 */}
                        {view === 'quiz' && (
                            <div className="bg-white p-8 rounded-3xl shadow-xl border border-stone-100 fade-in">
                                <div className="flex justify-between items-center mb-10">
                                    <span className="text-sm font-bold text-amber-600 bg-amber-50 px-4 py-1.5 rounded-full">第 {currentIndex + 1} / 5 題</span>
                                    <div className="w-32 h-2.5 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-amber-400 transition-all duration-500" style={{ width: `${((currentIndex + 1) / 5) * 100}%` }}></div></div>
                                </div>
                                <h2 className="text-xl font-bold mb-10 min-h-[5rem] leading-relaxed">{currentQuestions[currentIndex]?.q}</h2>
                                <div className="space-y-4">
                                    {currentQuestions[currentIndex]?.a.map((opt, i) => (
                                        <button key={i} onClick={() => handleAnswer(i)} className="w-full text-left p-5 rounded-xl border-2 border-stone-50 hover:border-amber-300 hover:bg-amber-50 flex items-center group transition-all">
                                            <span className="w-9 h-9 flex items-center justify-center bg-stone-100 group-hover:bg-amber-200 rounded-full mr-4 text-sm font-bold transition-colors">{String.fromCharCode(65 + i)}</span>{opt}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 證書結果 */}
                        {view === 'result' && (
                            <div className="space-y-6 fade-in">
                                <div className="bg-[#fffcf5] p-10 rounded-lg shadow-2xl border-[12px] border-double border-amber-800 relative overflow-hidden certificate-container">
                                    <div className="text-center relative z-10">
                                        <GraduationCap className="w-16 h-16 text-amber-800 mx-auto mb-4" />
                                        <h1 className="text-4xl font-serif font-bold text-amber-900 mb-8 tracking-widest text-center leading-tight">畢業證書</h1>
                                        <div className="space-y-6 font-serif text-stone-800">
                                            <p className="text-xl text-center">茲證明</p>
                                            <h2 className="text-5xl font-bold py-2 border-b-2 border-amber-200/50 inline-block px-10 text-stone-900">{playerName}</h2>
                                            <p className="text-xl text-center">參與隨堂測驗，獲得成績：</p>
                                            <div className="text-7xl font-black text-amber-700 my-6 drop-shadow-sm text-center">{score} <span className="text-3xl font-bold">分</span></div>
                                            <p className="text-xl text-center leading-loose">特發此證，以資鼓勵。</p>
                                        </div>
                                        <div className="mt-16 flex justify-between items-end">
                                            <div className="text-left text-sm text-stone-500 font-sans">日期：{new Date().toLocaleDateString('zh-TW')}</div>
                                            <div className="relative font-serif italic text-amber-900 text-2xl pr-8 text-center leading-tight">院長 歐大<div className="w-20 h-20 border-4 border-red-600/60 rounded-full flex items-center justify-center text-red-600/70 font-bold rotate-12 absolute -top-4 -right-12 opacity-80 text-lg leading-tight text-center">歐大<br/>選擇權</div></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 gap-4">
                                    <button onClick={() => { setView('leaderboard'); fetchLeaderboard(); }} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all"><Trophy className="w-5 h-5" /> 看排行榜</button>
                                    <div className="flex gap-4">
                                        <button onClick={() => window.print()} className="flex-1 bg-stone-800 text-white py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-black transition-all shadow-lg active:scale-95"><Download className="w-5 h-5" /> 下載證書</button>
                                        <button onClick={() => setView('home')} className="flex-1 bg-white text-stone-800 border-2 border-stone-100 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-stone-50 transition-all active:scale-95"><Home className="w-5 h-5" /> 回首頁</button>
                                    </div>
                                </div>

                                <div className="text-center h-6">
                                    {submitStatus === 'submitting' && <p className="text-sm text-stone-400 flex items-center justify-center gap-2"><Loader className="w-4 h-4" /> 紀錄自動上傳中...</p>}
                                    {submitStatus === 'success' && <p className="text-sm text-green-600 font-bold flex items-center justify-center gap-1"><Check className="w-4 h-4" /> 成績已成功自動紀錄</p>}
                                </div>
                            </div>
                        )}

                        {/* 排行榜 */}
                        {view === 'leaderboard' && (
                            <div className="bg-white/95 backdrop-blur-md p-8 rounded-3xl shadow-xl border border-stone-100 max-h-[85vh] flex flex-col fade-in">
                                <div className="flex justify-between items-center mb-8">
                                    <h2 className="text-2xl font-bold text-stone-900 flex items-center gap-3"><Trophy className="w-7 h-7 text-amber-500" /> 巔峰排行榜</h2>
                                    <button onClick={() => setView('home')} className="p-2 text-stone-400 hover:text-stone-600 transition-colors bg-stone-50 rounded-full"><Home className="w-6 h-6" /></button>
                                </div>
                                
                                <div className="overflow-y-auto flex-1 space-y-3 pr-2 scrollbar-thin">
                                    {isLoadingLeaderboard ? (
                                        <div className="text-center py-24 text-stone-400 flex flex-col items-center gap-4"><Loader className="w-8 h-8" /><p>載入排行榜中...</p></div>
                                    ) : errorMessage ? (
                                        <div className="text-center py-24 text-red-400 flex flex-col items-center gap-4">
                                            <p>{errorMessage}</p>
                                            <button onClick={fetchLeaderboard} className="text-amber-600 underline font-bold mt-2 hover:text-amber-700">點此重試刷新</button>
                                        </div>
                                    ) : leaderboard.length > 0 ? leaderboard.map((item, idx) => (
                                        <div key={idx} className="flex items-center justify-between p-5 bg-stone-50 rounded-2xl border border-stone-100/50 hover:bg-stone-100/50 transition-all">
                                            <div className="flex items-center gap-5">
                                                <span className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-base shadow-sm ${idx === 0 ? 'bg-amber-400 text-white' : idx === 1 ? 'bg-slate-300 text-white' : idx === 2 ? 'bg-amber-700/50 text-white' : 'bg-white text-stone-400'}`}>{idx + 1}</span>
                                                <div><div className="font-bold text-stone-800 text-lg">{item.name}</div><div className="text-xs text-stone-400 font-mono mt-0.5">{item.date}</div></div>
                                            </div>
                                            <div className="text-right"><span className="font-black text-amber-600 text-2xl">{item.score}</span><span className="text-xs text-amber-400 ml-1">pts</span></div>
                                        </div>
                                    )) : (
                                        <div className="text-center py-24 text-stone-400 flex flex-col items-center gap-4">
                                            <Trophy className="w-12 h-12 opacity-20" />
                                            <p className="text-lg text-center">尚無排行榜資料，快來成為第一人！</p>
                                            <button onClick={fetchLeaderboard} className="text-amber-600 underline text-sm mt-2">手動刷新</button>
                                        </div>
                                    )}
                                </div>
                                <button onClick={() => setView('home')} className="mt-8 w-full bg-stone-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition-all active:scale-95 shadow-lg">返回挑戰</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>